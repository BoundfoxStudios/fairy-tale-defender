name: Documentation Website

on:
  push:
    branches:
      - develop
    paths:
      - 'docs/**'
      - '.all-contributorsrc'
      - 'resources/BlenderStarterKit/**'
      - 'resources/ColorPalettes/**'
  workflow_dispatch:
  workflow_call:
    inputs:
      ref:
        default: ''
        required: true
        description: The ref to checkout.
        type: string
  schedule:
    - cron: '5 17 * * 1' # deploy the documentation website every monday after the new video went live

env:
  HUGO_YOUTUBE_API_KEY: ${{ secrets.HUGO_YOUTUBE_API_KEY }}

jobs:
  create-blender-starter-kit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ inputs.ref }}
      - run: mkdir BlenderStarterKit
      - run: cp ./resources/BlenderStarterKit/*.blend ./BlenderStarterKit
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      - run: npm install @webtoon/psd@0.3.0 pngjs@6.0.0
      - uses: actions/github-script@v6
        with:
          script: |
            const { default: Psd } = await import('${{ github.workspace }}/node_modules/@webtoon/psd/dist/index.js');
            const PNG = require('pngjs').PNG;
            const fs = require('fs');

            const psdData = fs.readFileSync('./resources/ColorPalettes/ColorPalette_Summer.psd');
            const psdFile = Psd.parse(psdData.buffer);

            const pixelData = await psdFile.composite();

            const png = new PNG({ width: psdFile.width, height: psdFile.height });
            png.data = Buffer.from(pixelData);
            png.pack().pipe(fs.createWriteStream('./BlenderStarterKit/ColorPalette_Summer.png'));
      - run: zip ./BlenderStarterKit/BlenderStarterKit.zip ./BlenderStarterKit/*.*
      - uses: actions/upload-artifact@v3
        with:
          name: BlenderStarterKit
          path: ./BlenderStarterKit/BlenderStarterKit.zip
  
  check-broken-links:
    runs-on: ubuntu-latest
    needs: [create-blender-starter-kit]
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ inputs.ref }}
      - uses: actions/download-artifact@v3
        with:
          name: BlenderStarterKit
          path: docs/content/docs/docs-visual/starter-kit/assets
      - uses: ./.github/actions/hugo-check-broken-links

  deploy:
    runs-on: ubuntu-latest
    needs: [check-broken-links, create-blender-starter-kit]
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: actions/download-artifact@v3
        with:
          name: BlenderStarterKit
          path: docs/static
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      - run: npm ci
        working-directory: docs
      - run: npm run publish
        working-directory: docs
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/public
          user_name: "Boundfox Studios Publish Bot"
          user_email: "info@boundfoxstudios.com"
          commit_message: ":rocket: Deploy Docs"
